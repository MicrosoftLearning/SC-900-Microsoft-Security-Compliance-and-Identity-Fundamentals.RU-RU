<!---
---
Практическое занятие. Заголовок: "Изучение групп безопасности сети Azure (NSG)" Схема обучения/Модуль/Урок: "Схема обучения. Описание возможностей решений безопасности Майкрософт; Модуль 1. Описание основных возможностей обеспечения безопасности в Azure; Урок 6. Описание групп безопасности сети Azure"
---
--->

# Практическое занятие. Изучение групп безопасности сетей Azure (NSGs)

Это практическое занятие выполняется на основе следующего содержимого Learn:

- Схема обучения. Описание возможностей решений безопасности Майкрософт
- Модуль. Описание основных возможностей обеспечения безопасности в Azure
- Урок. Описание групп безопасности сети Azure

## Сценарий практического занятия

В рамках этого практического занятия вы изучите функцию групп безопасности сети в Azure.  Для этого вы создадите группу безопасности сети (NSG) и назначите ее интерфейсу существующей виртуальной машины.  После настройки вы увидите правила для входящего и исходящего трафика по умолчанию, создадите новые правила и протестируете их.  В этом задании виртуальная машина, которую вы будете использовать с NSG, будет создана автоматически, поэтому вы сначала просмотрите некоторые сведения, связанные с ней.
  
**Примерное время**: 30–45 мин.

### Задача 1

В этой задаче вы просмотрите некоторые параметры, связанные с виртуальной машиной, созданной автоматически для использования в этом задании.

1. Откройте Microsoft Edge.  В адресной строке введите **https://portal.azure.com**.

1. Войдите под своими учетными данными администратора.
    1. В окне "Вход" введите имя пользователя, предоставленное поставщиком услуг размещения практических занятий, а затем нажмите кнопку **Далее**.
    1. Введите пароль администратора, который должен быть предоставлен поставщиком услуг размещения практических занятий. Выберите **Войти**.
    1. При появлении предложения не выходить из системы выберите **Да**.

1. В верхней части страницы под надписью «Службы Azure» выберите **Виртуальные машины**.  Если надпись отсутствует, в поле поиска, которое расположено на синей верхней панели рядом с надписью «Microsoft Azure», введите **Виртуальные машины**, затем выберите **Виртуальные машины** в результатах поиска.

1. На странице «Виртуальные машины» выберите **SC900-WinVM**.

1. Вы попадете на страницу SC900-WinVM.  Обратите внимание на некоторые основные сведения о виртуальной машине.

1. В верхней части страницы выберите **Подключиться**.  Выберите параметр **Проверить доступ**, который указан в разделе IP-адреса.  Это проверка будет выполняться с помощью порта 3389, который является портом для подключения по протоколу RDP.  Должно появиться сообщение "Не удается проверить".  В собственном поле RDP нажмите кнопку **Выбрать**.  В открывавшемся окне в разделе "1 Настройка необходимых компонентов для собственного протокола RDP" вы увидите сообщение "Azure необходимо настроить некоторые функции для подключения к виртуальной машине".  В следующей задаче вы настроите группу безопасности сети для явного разрешения подключения по протоколу RDP.


1. На панели навигации слева выберите **Сеть**.  
    1. По умолчанию используется представление для правил входящего порта.  Обратите внимание, что в сетевом интерфейсе этой виртуальной машины не настроены группы безопасности сети.  То же справедливо и при выборе правил исходящего порта.
    1. Выберите **Действующие правила безопасности** рядом с пунктом «Сетевой интерфейс».  Обратите внимание, что отображается сообщение «Нет групп безопасности сети или групп безопасности приложений, связанных с сетевым интерфейсом».

1. Не закрывайте эту вкладку браузера.


### Задача 2

В этой задаче вы создадите группу безопасности сети, назначите ей сетевой интерфейс виртуальной машины и создадите новое правило для входящего трафика RDP.

1. На открытой вкладке NSG *щелкните правой кнопкой мыши* ссылку **Главная** в верхней части страницы и выберите **Открыть ссылку на новой вкладке** , чтобы открыть другую страницу служб Azure.

1. В синей строке поиска в верхней части страницы введите **Группы безопасности сети** и в результатах выберите **Группы безопасности сети**. Не выбирайте *Группы безопасности сети (классические).*

1. В верхней части страницы групп безопасности сети выберите **+ Создать**.

1. На вкладке «Основные» страницы «Создание группы безопасности сети» укажите следующие параметры.
    1. Подписка: оставьте значение по умолчанию (это подписка Azure, предоставляемая авторизованным поставщиком размещения практических занятий).
    1. Группа ресурсов.  **LabsSC900**
    1. Имя:  **NSG-SC900**
    1. Регион: оставьте значение по умолчанию.
    1. Выберите **Проверить и создать**, затем выберите **Создать**.

1. По завершении развертывания выберите элемент **Перейти к ресурсу**.

1. В верхней части страницы под надписью "Основное" вы увидите некоторые основные сведения о созданной группе безопасности сети.  Следует отметить два момента: отсутствуют настраиваемые правила безопасности, и отсутствуют подсети и сетевые интерфейсы, связанные с этой группой безопасности сети.  Несмотря на отсутствие настраиваемых правил безопасности, существуют правила для входящего и исходящего трафика по умолчанию, которые включены в каждую группу безопасности сети, как показано на странице.  Просмотрите правила для входящего и исходящего трафика. Правила для входящего трафика по умолчанию запрещают весь входящий трафик, который поступает не из виртуальной сети или подсистемы балансировки нагрузки Azure.  Правила для исходящего трафика запрещают весь исходящий трафик, кроме трафика между виртуальными сетями и исходящего трафика в Интернет.

1. В разделе «Параметры» на панели навигации в левой части страницы NSG-SC900 выберите **Сетевые интерфейсы**.
    1. Выберите **Связать**.
    2. В поле для сопоставлений сетевого интерфейса щелкните **стрелку вниз**, выберите **sc900-winvmXXX**, а затем нажмите **кнопку ОК** в нижней части окна. После сопоставления интерфейса с NSG этот интерфейс появится в списке.

1. В области навигации слева выберите **Правила безопасности для входящего трафика**.

1. Правила для входящего трафика по умолчанию запрещают весь входящий трафик, не исходящий из виртуальной сети или подсистемы балансировки нагрузки Azure, поэтому необходимо настроить правило, разрешающее входящий трафик RDP (трафик через порт 3389). Помните, что правила по умолчанию нельзя удалить, но их можно переопределить, создавая правила с более высоким приоритетом.

1. В верхней части страницы щелкните **Добавить**. В окне "Добавление правила безопасности входящего трафика" укажите следующие параметры:
    1. Источник:  **Любой**
    1. Диапазоны исходных портов: **\*** .
    1. Место назначения:  **Любой**
    1. Служба:  **RDP**
    1. Действие:  **Разрешить**
    1. Приоритет: **1000**. Правила с меньшими числами имеют более высокий приоритет и обрабатываются в первую очередь.
    1. Имя: оставьте имя по умолчанию или создайте собственное описательное имя.
    1. Обратите внимание на знак предупреждения в нижней части страницы.  Мы используем RDP только в целях тестирования и для демонстрации работы группы безопасности сети.
    1. Нажмите **Добавить**

1. Как только правило будет подготовлено, оно появится в списке правил для входящего трафика (возможно, вам потребуется обновить экран).

1. Не закрывайте эту вкладку браузера.  

### Задача 3

В этой задаче вы протестируете только что созданное правило NSG для входящего трафика, чтобы убедиться в возможности установить подключение к виртуальной машине через удаленный рабочий стол (RDP).  В виртуальной машине вы сможете проверка исходящее подключение к Интернету из виртуальной машины.

1. Откройте вкладку «SC900-WinVM – Microsoft Azure» в вашем браузере. Если вы ранее закрыли вкладку браузера, откройте новую вкладку браузера, введите **https://portal.azure.com**и выберите **Виртуальные машины**, а затем выберите виртуальную машину **SC900-WinVM**.

1. Выберите **Подключить** на панели навигации слева.

1. Выберите **проверка доступ** (убедитесь, что для порта задано значение 3389).  Состояние должно отображаться как "Доступно".

1. Теперь подключитесь непосредственно к виртуальной машине, нажав кнопку **Выбрать** в поле с надписью Native RDP.
   
    1. В открывающемся окне Собственный RDP выберите **Скачать RDP-файл**.
    1. Если появится предупреждение о скачивании, выберите **Сохранить**, а затем во всплывающем окне выберите **Открыть файл**.
    1. Откроется окно Подключение к удаленному рабочему столу; Выберите **Подключиться**.
    1. Вам будет предложено ввести свои учетные данные.  Введите имя пользователя и пароль для виртуальной машины (см. вкладку ресурсы на панели инструкций лаборатории).
    1. Откроется окно подключения к удаленному рабочему столу, в котором указано, что *удостоверение удаленного компьютера не может быть проверено.  Вы хотите подключиться в любом случае?*  Выберите ответ **Да**.

1. Теперь вы подключены к виртуальной машине. В этом случае вы смогли подключиться к ВМ, потому что созданное вами правило входящего трафика пропускает входящий трафик к ВМ через RDP.  Через несколько секунд на экране приветствия появится окно Выберите параметры конфиденциальности для устройства и нажмите **кнопку Принять**.  Если появится окно Сети, выберите **Нет**.

1. Если виртуальная машина в сеансе RDP запущена и запущена, проверьте исходящее подключение к Интернету из виртуальной машины.
    1. На открытой виртуальной машине выберите **Microsoft Edge** , чтобы открыть браузер.  Так как вы открываете Microsoft Edge в первый раз, вы можете во всплывающем окне выбрать **Запустить без данных**, а затем — **Продолжить без этих данных** и после этого — **Подтвердить и начать просмотр**.
    1. Введите **www.bing.com** в адресной строке браузера и убедитесь, что вы можете подключиться к поисковой системе.
    1. Убедившись, что у вас есть доступ к www.bing.com, закройте окно браузера на виртуальной машине, но не отключайте саму виртуальную машину.

1. Сверните виртуальную машину, выбрав подчеркивание **_** на синей вкладке, на которой отображается IP-адрес виртуальной машины. Вы вернееесь на страницу SC900-WinVM \| Connect.

1. Не закрывайте вкладку браузера; Вы будете использовать его в следующей задаче.

### Задача 4.

В предыдущей задаче вы подтвердили, что можно установить RDP-подключение к виртуальной машине. На виртуальной машине вы также подтвердили, что можете установить исходящее подключение к Интернету.  Исходящий интернет-трафик был разрешен, так как правила исходящего трафика по умолчанию для NSG разрешают исходящий интернет-трафик.  В этой задаче вы узнаете, как создать пользовательское правило для исходящего интернет-трафика и протестировать это правило.

1. Вы должны находиться на странице SC900-WinVM \| Connect. На панели навигации слева выберите **Сеть**. Если вы ранее закрыли вкладку браузера, щелкните синюю панель поиска в верхней части страницы и выберите "Виртуальные машины", затем — виртуальную машину **SC900-WinVM**, а после этого — пункт **Сеть**.

1. Перейдите на вкладку **Правила исходящего порта**. Вы увидите правила для исходящего трафика по умолчанию.  Обратите внимание на правило по умолчанию «AllowInternetOutBound». Это правило разрешает весь исходящий интернет-трафик. Вы не можете удалить правило по умолчанию, однако можно переопределить его, создав правило с более высоким приоритетом. В правой части страницы выберите **Добавить правило исходящего порта**.

1. На странице «Добавить правило безопасности исходящего трафика» укажите следующие параметры:
    1. Источник:  **Любой**
    1. Диапазоны исходных портов: **\*** .
    1. Место назначения:  **Тег службы**
    1. Тег службы назначения:  **Интернет**
    1. Служба:  **Пользовательская** (оставьте значение по умолчанию)
    1. Диапазоны портов назначения:  **\*** (не забудьте поместить звездочку в поле Диапазоны портов назначения)
    1. Протокол: **Любой**
    1. Действие: **Deny**
    1. Приоритет: **1000**
    1. Имя: оставьте имя по умолчанию или создайте собственное описательное имя.
    1. Нажмите **Добавить**

1. После подготовки правила оно появится в списке правил исходящего трафика.  Несмотря на отображение этого правила в списке оно вступит в силу только через несколько минут (подождите несколько минут, прежде чем переходить к дальнейшим действиям).  


1. Вернитесь к виртуальной машине (значок RDP для виртуальной машины должен отображаться на панели задач в нижней части страницы).

1. Откройте браузер Microsoft Edge на виртуальной машине и введите **www.bing.com**. Страница не должна отображаться. Если вы можете подключиться к Интернету и убедились, что все параметры правила для исходящего трафика правильно заданы, скорее всего, это связано с тем, что это правило вступает в силу через несколько минут.  Закройте браузер, подождите несколько минут и повторите попытку. В подписках Azure в лабораторной среде задержки могут быть дольше обычного.


1. Закройте подключение к удаленному рабочему столу, выбрав **X** в центре верхней части страницы, где отображается IP-адрес.  Появляется всплывающее окно с сообщением об отключении удаленного сеанса. Щелкните **ОК**.

1. В левом верхнем углу окна, под синей панелью, где указано Microsoft Azure, выберите **Главная** , чтобы вернуться на домашнюю страницу служб Azure.

1. Не закрывайте вкладку Azure в браузере.

### Просмотр

В этом задании вы узнали, как настроить группу безопасности сети (NSG), связав эту группу безопасности сети с сетевым интерфейсом виртуальной машины и добавив новые правила в группу безопасности сети, чтобы разрешить входящий трафик RDP и заблокировать исходящий интернет-трафик.
