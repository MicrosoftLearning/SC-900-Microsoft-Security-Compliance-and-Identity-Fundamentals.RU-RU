<!---
---
Практическое занятие. Заголовок: "Изучение групп безопасности сети Azure (NSG)" Схема обучения/Модуль/Урок: "Схема обучения. Описание возможностей решений безопасности Майкрософт; Модуль 1. Описание основных возможностей обеспечения безопасности в Azure; Урок 6. Описание групп безопасности сети Azure"
---
--->

# Практическое занятие: знакомство с группами безопасности сети (NSG) Azure

Это практическое занятие выполняется на основе следующего содержимого Learn:

- Схема обучения. Описание возможностей решений Майкрософт по обеспечению безопасности
- Модуль. Описание основных возможностей обеспечения безопасности в Azure
- Урок. Описание групп безопасности сети Azure

## Сценарий практической работы

В рамках этого практического занятия вы изучите функцию групп безопасности сети в Azure.  Для этого вы создадите группу безопасности сети (NSG) и назначите ее интерфейсу существующей виртуальной машины.  После настройки вы увидите правила для входящего и исходящего трафика по умолчанию, создадите новые правила и протестируете их.  В этом задании виртуальная машина, которую вы будете использовать с NSG, будет создана автоматически, поэтому вы сначала просмотрите некоторые сведения, связанные с ней.
  
**Предполагаемое время**: 30-45 минут

### Задача 1

В этой задаче вы просмотрите некоторые параметры, связанные с виртуальной машиной, созданной автоматически для использования в этом задании.

1. Откройте Microsoft Edge.  В адресной строке введите **https://portal.azure.com**.

1. Выполните вход с использованием учетных данных администратора.
    1. В окне "Вход" введите имя пользователя, предоставленное поставщиком услуг размещения практических занятий, а затем нажмите кнопку **Далее**.
    1. Введите пароль администратора, который должен быть предоставлен поставщиком услуг размещения практических занятий. Выберите **Вход.**
    1. При появлении предложения не выходить из системы выберите **Да**.

1. В верхней части страницы под надписью "Службы Azure" выберите **Виртуальные машины**.  Если надпись отсутствует, в поле поиска, которое расположено на синей верхней панели рядом с надписью "Microsoft Azure", введите **Виртуальные машины**, затем выберите **Виртуальные машины** в результатах поиска.

1. На странице "Виртуальные машины" выберите **SC900-WinVM**.

1. Вы попадете на страницу SC900-WinVM.  Обратите внимание на некоторые основные сведения о виртуальной машине.

1. В верхней части страницы выберите **Подключение**.  Выберите опцию **Проверка доступа**, которая указана под IP-адресом.  Эта проверка будет выполнена с использованием порта 3389, который является портом для подключения RDP.  Должно появиться сообщение "Невозможно проверить".  В поле "Native RDP" нажмите **Выбрать**.  В открывшемся окне в разделе "1 Настройка предварительных условий для Native RDP" должно появиться сообщение "Azure необходимо настроить некоторые функции для подключения к виртуальной машине".  В следующей задаче вы настроите NSG для явного разрешения подключения RDP.


1. На панели навигации слева выберите **Сеть**.  
    1. По умолчанию используется представление для правил входящего порта.  Обратите внимание, что в сетевом интерфейсе этой виртуальной машины не настроены группы безопасности сети.  То же справедливо и при выборе правил исходящего порта.
    1. Выберите **Действующие правила безопасности** рядом с пунктом "Сетевой интерфейс".  Обратите внимание, что отображается сообщение "Нет групп безопасности сети или групп безопасности приложений, связанных с сетевым интерфейсом".

1. Не закрывайте эту вкладку браузера.


### Задача 2

В этой задаче вы создадите группу безопасности сети, назначите ей сетевой интерфейс виртуальной машины и создадите новое правило для входящего трафика RDP.

1. На открытой вкладке NSG *щелкните правой кнопкой мыши* на ссылку **Главная** в верхней части страницы и выберите **Открыть ссылку в новой вкладке**, чтобы открыть другую страницу служб Azure.

1. В синей строке поиска в верхней части страницы введите **Группы безопасности сети** и в результатах выберите **Группы безопасности сети**. Не выбирайте *Группы безопасности сети (классическая модель)*.

1. В верхней части страницы Группы безопасности сети выберите **+ Создать**.

1. На вкладке «Основные» страницы «Создать группу безопасности сети» укажите следующие параметры:
    1. Подписка: оставьте значение по умолчанию (это подписка Azure, предоставляемая авторизованным поставщиком услуг размещения практических занятий).
    1. Группа ресурсов:  **LabsSC900**
    1. Имя:  **NSG-SC900**
    1. Регион: оставьте значение по умолчанию.
    1. Выберите **Проверить + создать**, а затем выберите **Создать**.

1. По завершении развертывания выберите элемент **Перейти к ресурсу**.

1. В верхней части страницы под надписью «Основное» вы увидите некоторые основные сведения о созданной группе безопасности сети.  Следует отметить два момента: отсутствуют настраиваемые правила безопасности, и отсутствуют подсети и сетевые интерфейсы, связанные с этой группой безопасности сети.  Несмотря на отсутствие настраиваемых правил безопасности, существуют правила для входящего и исходящего трафика по умолчанию, которые включены в каждую группу безопасности сети, как показано на странице.  Просмотрите правила для входящего и исходящего трафика. Правила для входящего трафика по умолчанию запрещают весь входящий трафик, который поступает не из виртуальной сети или подсистемы балансировки нагрузки Azure.  Правила для исходящего трафика запрещают весь исходящий трафик, кроме трафика между виртуальными сетями и исходящего трафика в Интернет.

1. В разделе "Параметры" на панели навигации в левой части страницы NSG-SC900 выберите **Сетевые интерфейсы**.
    1. Выберите **Связать**.
    2. В поле выбора связей сетевого интерфейса щелкните **стрелку вниз**, выберите **sc900-winvmXXX**, а затем нажмите **ОК** в нижней части окна. Как только интерфейс будет связан с Группой безопасности сети, он будет отображаться в списке.

1. В области навигации слева выберите **Правила безопасности для входящего трафика**.

1. Правила для входящего трафика по умолчанию запрещают весь входящий трафик, не исходящий из виртуальной сети или подсистемы балансировки нагрузки Azure, поэтому необходимо настроить правило, разрешающее входящий трафик RDP (трафик через порт 3389). Помните, что правила по умолчанию нельзя удалить, но их можно переопределить, создавая правила с более высоким приоритетом.

1. В верхней части страницы щелкните **Добавить**. В окне "Добавление правила безопасности входящего трафика" укажите следующие параметры:
    1. Источник:  **Любой**
    1. Диапазоны исходных портов: **\***
    1. Назначение:  **Любое**
    1. Служба:  **RDP**
    1. Действие:  **Разрешить**
    1. Приоритет: **1000**. Правила с более низкими номерами имеют более высокий приоритет и обрабатываются первыми.
    1. Имя: оставьте имя по умолчанию или создайте собственное описательное имя.
    1. Обратите внимание на знак предупреждения в нижней части страницы.  Мы используем RDP только в целях тестирования и для демонстрации работы группы безопасности сети.
    1. Выберите **Добавить**

1. Как только правило будет подготовлено, оно появится в списке правил для входящего трафика (возможно, вам потребуется обновить экран).

1. Не закрывайте эту вкладку браузера.  

### Задача 3

В этой задаче вы протестируете только что созданное правило NSG для входящего трафика, чтобы убедиться в возможности установить подключение к виртуальной машине через удаленный рабочий стол (RDP).  В виртуальной машине вы сможете проверить исходящее подключение к Интернету с виртуальной машины.

1. Откройте SC900-WinVM — вкладку Microsoft Azure в браузере. Если вы ранее закрыли вкладку браузера, откройте новую вкладку браузера, введите **https://portal.azure.com** и выберите **Виртуальные машины**, а затем выберите виртуальную машину **SC900-WinVM**.

1. На панели навигации слева выберите **Подключить**.

1. Выберите **проверка доступа** (убедитесь, что порт имеет значение 3389).  Состояние должно отображаться как "Доступно".

1. Теперь подключитесь непосредственно к виртуальной машине, нажав кнопку **Выбрать** в поле, где указан Собственный RDP.
   
    1. В открывающемся окне Собственного RDP выберите **Скачать RDP-файл**.
    1. Если появится предупреждение о загрузке, нажмите кнопку **Сохранить**, а затем во всплывающем окне, которое появится, выберите **Открыть файл**.
    1. Откроется окно "Подключение к удаленному рабочему столу". Выберите в нем команду **Подключиться**.
    1. Вам будет предложено ввести свои учетные данные.  Введите Имя пользователя и Пароль для виртуальной машины (см. вкладку ресурсов на панели инструкций к заданию).
    1. Откроется окно подключения к удаленному рабочему столу, указывающее: *Удостоверение удаленного компьютера невозможно проверить.  Вы хотите подключиться в любом случае?*  Выберите **Да**.

1. Теперь вы подключены к виртуальной машине. В этом случае вы смогли подключиться к виртуальной машине, потому что созданное вами правило входящего трафика пропускает входящий трафик к виртуальной машине через протокол удаленного рабочего стола.  Через несколько секунд на экране приветствия появится окно выбора параметров конфиденциальности для устройства. Нажмите кнопку **Принять**.  Если появится окно "Сети", выберите **Нет**.

1. Когда виртуальная машина в сеансе RDP запущена и работает, проверьте исходящее подключение с нее к Интернету.
    1. На открытой виртуальной машине выберите **Microsoft Edge**, чтобы открыть браузер.  Так как вы открываете Microsoft Edge в первый раз, вы можете во всплывающем окне выбрать **Запустить без данных**, затем — **Продолжить без этих данных**, а после этого — **Подтвердить и начать просмотр**.
    1. Введите **www.bing.com** в адресной строке браузера и убедитесь в том, что вы можете подключиться к поисковой системе.
    1. Убедившись в наличии доступа к www.bing.com, закройте окно браузера на виртуальной машине, но не отключайте саму виртуальную машину.

1. Сверните виртуальную машину, выбрав символ подчеркивания **_** на синей вкладке, где отображается IP-адрес виртуальной машины. Вы вернетесь на страницу "SC900-WinVM \| Подключение".

1. Не закрывайте вкладку браузера; так как она будет использоваться в следующей задаче.

### Задача 4

В предыдущей задаче вы подтвердили, что можно установить RDP-подключение к виртуальной машине. После входа в виртуальную машину вы также подтвердили, что можете установить исходящее подключение к Интернету.  Исходящий Интернет-трафик был разрешен, так как правила для исходящего трафика по умолчанию для NSG разрешают его.  В этой задаче будет создано пользовательское правило исходящего трафика для блокировки исходящего трафика в Интернет и его тестирование.

1. Необходимо находиться на странице SC900-WinVM \| Подключение. На панели навигации слева выберите **Сеть**. Если вы ранее закрыли вкладку браузера, щелкните синюю панель поиска в верхней части страницы и выберите "Виртуальные машины", затем — виртуальную машину **SC900-WinVM**, а после этого — пункт **Сеть**.

1. Перейдите на вкладку **Правила исходящего порта**. Вы увидите правила для исходящего трафика по умолчанию.  Обратите внимание на правило по умолчанию "AllowInternetOutBound". Это правило разрешает весь исходящий Интернет-трафик. Невозможно удалить правило по умолчанию, но можно переопределить его, создав правило с более высоким приоритетом. В правой части страницы выберите **Добавить правило исходящего порта**.

1. На странице Добавить правило безопасности для исходящего трафика укажите следующие параметры:
    1. Источник:  **Любой**
    1. Диапазоны исходных портов: **\***.
    1. Назначение: **Тег службы**
    1. Тег службы назначения: **Интернет**
    1. Служба: **Пользовательская** (оставьте значение по умолчанию)
    1. Диапазоны портов назначения: **\*** (обязательно поставьте звездочку в поле диапазонов портов назначения)
    1. Протокол: **Любой**
    1. Действие: **Запретить**
    1. Приоритет: **1000**
    1. Имя: оставьте имя по умолчанию или создайте собственное описательное имя.
    1. Выберите **Добавить**

1. Как только правило будет создано, оно появится в списке правил для исходящего трафика.  Несмотря на то, что оно появится в списке, изменения вступят в силу через несколько минут (подождите несколько минут, прежде чем продолжить дальнейшие действия).  


1. Вернитесь к виртуальной машине (значок RDP для виртуальной машины должен отображаться на панели задач в нижней части страницы).

1. Откройте браузер Microsoft Edge на виртуальной машине и введите **www.bing.com**. Эта страница не должна отображаться. Если вы можете подключиться к Интернету и убедились в том, что все параметры для правил исходящего трафика правильно настроены, скорее всего, необходимо подождать несколько минут, чтобы правило вступило в силу.  Закройте браузер, подождите несколько минут и повторите попытку. В подписках Azure в лабораторной среде могут возникать более длительные задержки.


1. Закройте подключение к удаленному рабочему столу, нажав кнопку **X** в верхней центральной части страницы, где отображается IP-адрес.  Появляется всплывающее окно с сообщением об отключении удаленного сеанса. Нажмите **ОК**.

1. В левом верхнем углу окна под синей панелью, где написано Microsoft Azure, выберите **Главная**, чтобы вернуться на домашнюю страницу служб Azure.

1. Не закрывайте вкладку Azure в браузере.

### Отзыв

В этом занятии показано, как настроить группу безопасности сети (NSG), связать ее с сетевым интерфейсом виртуальной машины и добавить в неё новые правила, чтобы разрешить входящий трафик RDP и заблокировать исходящий Интернет-трафик.
