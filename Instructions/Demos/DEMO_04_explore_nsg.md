<!---
---
Демонстрация. Заголовок: "Группы безопасности сети Azure (NSG)" Схема обучения/Модуль/Урок: "Схема обучения. Описание возможностей решений безопасности Майкрософт; Модуль 1. Описание основных возможностей обеспечения безопасности в Azure; Урок 6. Описание групп безопасности сети Azure"
---
--->

# Ролик: Группы безопасности сети (NSG) Azure

Эта демонстрация выполняется на основе следующего содержимого Learn:

- Схема обучения. Описание возможностей решений Майкрософт по обеспечению безопасности
- Модуль. Описание основных возможностей обеспечения безопасности в Azure
- Урок. Описание групп безопасности сети Azure

## Демонстрационный сценарий

В этой демонстрации вы изучите работу групп безопасности сети в Azure и примените группу безопасности сети к предварительно созданной виртуальной машине. Сначала вы кратко продемонстрируете сведения о виртуальной машине, которая была предварительно создана авторизованным поставщиком размещения практических занятий (ALH). Затем, используя группу безопасности сети, которая была настроена в рамках предварительной демонстрационной настройки, вы увидите основные параметры группы безопасности сети и правила входящего и исходящего трафика по умолчанию. Вы назначите интерфейс виртуальной машины группе безопасности сети, создадите новое правило RDP, чтобы разрешить подключение к виртуальной машине, и, наконец, протестируете его.

### Демонстрация, часть 1.

В этой части вы увидите некоторые параметры, связанные с виртуальной машиной, созданной в рамках демонстрации настройки (DEMO_00_pre_demo_setup.md).

1. Откройте Microsoft Edge.  В адресной строке введите **https://portal.azure.com** и войдите с помощью учетных данных Azure, предоставленных полномочным поставщиком услуг размещения заданий (ALH).  Это позволит вам открыть домашнюю страницу служб Azure.

1. В поле поиска вверху страницы введите **Виртуальные машины** и выберите **Виртуальные машины** из результатов поиска.

1. На странице "Виртуальные машины" выберите **SC900-WinVM**.  Эта виртуальная машина должна быть создана в рамках настройки перед демонстрацией.  Если она не указана, создайте ее сейчас.

1. Вы попадете на страницу SC900-WinVM.  Обратите внимание на некоторые основные сведения о виртуальной машине.

1. На панели навигации слева выберите **Сеть**.  
    1. По умолчанию используется представление для правил входящего порта.  Обратите внимание, что в сетевом интерфейсе этой виртуальной машины не настроены группы безопасности сети.  То же справедливо и при выборе правил исходящего порта.
    1. Выберите **Действующие правила безопасности** рядом с пунктом "Сетевой интерфейс".  Обратите внимание, что отображается сообщение "Нет групп безопасности сети или групп безопасности приложений, связанных с сетевым интерфейсом".

1. Примечание для докладчика. Если вы попытаетесь проверить состояние порта на странице подключения, вы получите сообщение "Не удается проверить".  Это не обязательно означает, что порты не доступны.  Как вы заметите, когда вы выполняете то же действие с назначенной Группой безопасности сети, вы получаете сообщение "Недоступно", указывающее, что трафик на этом порту заблокирован.


1. Не закрывайте эту вкладку браузера.

### Демонстрация, часть 2.

В этой части вы назначите интерфейс для группы безопасности сети, вы расскажете о правилах для входящего и исходящего трафика по умолчанию, показав, как эти правила работают.  В рамках настройки перед демонстрацией виртуальная машина должна назначить сетевой интерфейс виртуальной машины этой группе безопасности сети и создать новое правило для входящего трафика RDP.

1. Откройте новую вкладку браузера для портала Azure (portal.azure.com) и в синей строке поиска в верхней части страницы введите группы **Группы безопасности сети**. В списке результатов выберите **Группы безопасности сети** (не выбирайте "Классические группы безопасности сети").

1. Выберите группу безопасности сети, созданную в рамках настройки перед демонстрацией. Если вы не создали ее ранее, сделайте это сейчас. Выберите **Создать группу безопасности сети** и укажите следующие параметры:
    1. Подписка: оставьте значение по умолчанию (это подписка Azure, предоставляемая авторизованным поставщиком услуг размещения практических занятий).
    1. Группа ресурсов:  **LabsSC900** (та же группа ресурсов, используемая виртуальной машиной).
    1. Имя:  **NSG-SC900**
    1. Регион: оставьте значение по умолчанию.
    1. Выберите **Проверить + создать**, а затем выберите **Создать**.
    1. После завершения развертывания (это происходит очень быстро) выберите **Перейти к ресурсу**.

1. В верхней части страницы под надписью «Основное» вы увидите некоторые основные сведения о созданной группе безопасности сети.  Следует отметить 2 момента: отсутствуют настраиваемые правила безопасности, и отсутствуют подсети и сетевые интерфейсы, связанные с этой группой безопасности сети.  Несмотря на отсутствие настраиваемых правил безопасности, существуют правила для входящего и исходящего трафика по умолчанию, которые включены в каждую группу безопасности сети, как показано на странице.  Просмотрите правила для входящего и исходящего трафика. Правила для входящего трафика по умолчанию запрещают весь входящий трафик, который поступает не из виртуальной сети или подсистемы балансировки нагрузки Azure.  Правила для исходящего трафика запрещают весь исходящий трафик, кроме трафика между виртуальными сетями и исходящего трафика в Интернет.

1. В разделе «Параметры» на панели навигации в левой части страницы NSG-SC900 выберите **Сетевые интерфейсы**.
    1. Выберите **Связать**.
    1. В поле выбора связей сетевого интерфейса щелкните **стрелку раскрывающегося списка**, выберите **sc900-winvmXXX,** а затем нажмите кнопку **ОК** в нижней части окна. Как только интерфейс будет связан с Группой безопасности сети, он будет отображаться в списке.

1. Верните виртуальную машину, выбрав вкладку браузера для виртуальной машины.  Вы увидите, что теперь Группа безопасности сети подключена к интерфейсу виртуальной машины.  Отображается таблица правил для входящих портов. Правила для входящего трафика по умолчанию запрещают весь входящий трафик, который поступает не из виртуальной сети или подсистемы балансировки нагрузки Azure.  Чтобы проверить это, вы должны проверить состояние порта RDP, 3389.
    1. В верхней части страницы выберите **Подключение**, затем выберите **Проверить доступ** для порта 3389 (RDP), вы увидите "Недоступен".  
    1. Хотя вы тестируете только порт 3389 RDP, весь входящий сетевой трафик, исходящий не из другой виртуальной сети или балансировщика нагрузки, блокируется.  

1. Теперь вам нужно создать правило, чтобы разрешить входящий трафик на порт RDP.  На панели навигации слева выберите **Сеть**. Должна отображаться таблица Правила входящего порта (вкладка Правил входящего порта подчеркнута).  В правой части страницы выберите **Добавить правило входящего порта**. Важно отметить, что вы не можете удалить правила по умолчанию, но можете переопределить их, создав правила с более высоким приоритетом. В окне "Добавление правила безопасности входящего трафика" укажите следующие параметры:
    1. Источник:  **Любой**
    1. Диапазоны исходных портов: **\***
    1. Назначение:  **Любое**
    1. Служба:  **RDP**
    1. Действие:  **Разрешить**
    1. Приоритет:  **1000**. Примечание. Правила с более низкими номерами имеют более высокий приоритет и обрабатываются первыми.
    1. Имя: оставьте имя по умолчанию или создайте собственное описательное имя.
    1. Обратите внимание на знак предупреждения в нижней части страницы.  Мы используем RDP для только в целях тестирования и для демонстрации функциональности группы безопасности сети.
    1. Выберите **Добавить**

1. Как только правило будет подготовлено, оно появится в списке правил для входящего трафика (возможно, вам потребуется обновить экран).

### Демонстрация, часть 3.

Связав группу безопасности сети с вашей виртуальной машиной и создав правило RDP, вы сможете продемонстрировать влияние группы безопасности сети, проверив подключение RDP к виртуальной машине.

1. Откройте SC900-WinVM — вкладку Microsoft Azure в браузере. 

1. На панели навигации слева выберите **Подключить**.
    1. Вы можете просто выбрать **Проверка доступа**.  Состояние должно отображаться как "Доступно". Кроме того, если у вас есть время, вы можете подключиться к виртуальной машине, открыв экземпляр Подключения к удаленному рабочему столу в Windows.  Этот параметр откроет виртуальную машину после успешного подключения к ней.  Ниже перечислены действия:
        1. В строке поиска Windows введите **Подключение к удаленному рабочему столу** и нажмите **Открыть**.
        1. В поле рядом с надписью **Компьютер** введите общедоступный IP-адрес вашей виртуальной машины.
        1. После ввода IP-адреса имя пользователя должно отображаться под полем, в котором вы ввели IP-адрес. Если нет, разверните узел **Показать параметры** и введите имя пользователя для виртуальной машины, а затем выберите **Подключение**.
        1. Откроется окно подключения к Удаленному рабочему столу, указывающее, что удостоверение удаленного компьютера невозможно проверить. Вы хотите подключиться в любом случае? Выберите **Да**.
        1. Теперь вы подключены к виртуальной машине. Обратите внимание обучающегося, что в этом случае вы смогли подключиться к виртуальной машине, потому что созданное вами правило входящего трафика пропускает входящий трафик через протокол удаленного рабочего стола.
        1. Сверните виртуальную машину, выбрав символ подчеркивания **_** на синей вкладке, где отображается IP-адрес виртуальной машины. Вы вернетесь на страницу "SC900-WinVM | Подключение".

1. На панели навигации слева выберите **Сеть**, затем в главном окне выберите **Правила исходящего порта**.  Следует рассказать о правилах для исходящего трафика по умолчанию. Правила по умолчанию разрешают исходящий трафик VNet из любой виртуальной сети в любую другую виртуальную сеть и разрешают исходящий интернет-трафик. Все остальные типы исходящего трафика запрещены.  Невозможно удалить правило по умолчанию, но можно переопределить его, создав правило с более высоким приоритетом так же, как при создании правила для входящего трафика.

1. Если таймер разрешает провести операцию с исходящим трафиком, просмотрите дополнительную демонстрационную часть, приведенную ниже.  В противном случае выйдите из виртуальной машины, но оставьте вкладку Azure открытой в браузере для следующей демонстрации.

### Необязательная демонстрация, часть 4.

В этой части будет показано, как текущие исходящие правила NSG разрешают исходящий интернет-трафик из виртуальной машины.  Затем будет создано правило, блокирующее исходящий интернет-трафик из виртуальной машины, и, наконец, будет показано влияние созданного правила с помощью попытки доступа к интернету из виртуальной машины.

1. Откройте виртуальную машину, свёрнутую на предыдущем шаге. Здесь отображается исходящее подключение к Интернету, которое разрешено одним из правил исходящих соединений по умолчанию. После открытия виртуальной машины и входа в систему в качестве пользователя выберите **Microsoft Edge**, чтобы открыть браузер.  Так как вы открываете Microsoft Edge в первый раз, вы можете во всплывающем окне выбрать **Запустить без данных**, затем — **Продолжить без этих данных**, а после этого — **Подтвердить и начать просмотр**.
    1. Введите **www.bing.com** в адресной строке браузера и убедитесь в том, что вы можете подключиться к поисковой системе.
    1. Убедившись в наличии доступа к www.bing.com, закройте окно браузера на виртуальной машине, но не отключайте саму виртуальную машину.

1. Сверните виртуальную машину, выбрав символ подчеркивания **_** на синей вкладке, где отображается IP-адрес виртуальной машины. Вы вернетесь на страницу "SC900-WinVM | Подключение".  

1. На панели навигации слева выберите **Сеть**.

1. Перейдите на вкладку **Правила исходящего порта**. Вы увидите правила для исходящего трафика по умолчанию.  Обратите внимание на правило по умолчанию "AllowInternetOutBound". Это правило разрешает весь исходящий интернет-трафик. Невозможно удалить правило по умолчанию, но можно переопределить его, создав правило с более высоким приоритетом. В правой части страницы выберите **Добавить правило исходящего порта**.

1. На странице Добавить правило безопасности для исходящего трафика укажите следующие параметры:
    1. Источник:  **Любой**
    1. Диапазоны исходных портов: **\***.
    1. Назначение: **Тег службы**
    1. Тег службы назначения: **Интернет**
    1. Служба: **Пользовательская** (оставьте значение по умолчанию)
    1. Диапазоны портов назначения: * (обязательно поставьте звездочку в поле диапазонов портов назначения)
    1. Протокол: **Любой**
    1. Действие: **Запретить**
    1. Приоритет: **1000**
    1. Имя: оставьте имя по умолчанию или создайте собственное описательное имя.
    1. Выберите **Добавить**

1. Как только правило будет создано, оно появится в списке правил для исходящего трафика.  Несмотря на то, что оно появится в списке, изменения вступят в силу через несколько минут (подождите несколько минут, прежде чем продолжить дальнейшие действия).  

1. Вернитесь к виртуальной машине (значок виртуальной машины должен отображаться на панели задач в нижней части страницы).

1. Откройте браузер Microsoft Edge на виртуальной машине и введите **www.bing.com**. Эта страница не должна отображаться.  Примечание. Если вы можете подключиться к Интернету и убедились в том, что все параметры для правил исходящего трафика правильно настроены, скорее всего, необходимо подождать несколько минут, чтобы правило вступило в силу.  Закройте браузер, подождите несколько минут и повторите попытку.  Примечание. В подписках Azure в лабораторной среде могут возникать более длительные задержки.

1. Закройте подключение к удаленному рабочему столу, нажав кнопку **X** в верхней центральной части страницы, где отображается IP-адрес.  Появляется всплывающее окно с сообщением об отключении удаленного сеанса. Нажмите **ОК**.

1. Не закрывайте вкладку Azure в браузере, чтобы посмотреть следующую демонстрацию Azure.

### Отзыв

В рамках этой демонстрации вы изучили сведения и настройки, связанные с группой безопасности сети, включая процедуру привязки интерфейса к группе безопасности сети, продемонстрировали правила для входящего и исходящего трафика по умолчанию, а также действия по созданию нового правила.
